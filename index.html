<!doctype html>
<style>
body {margin: 0; height: 100vh;}
canvas {width: 100%; height: 100%;}
</style>
<canvas></canvas>
<script type="module">

let canvas = document.querySelector('canvas')
let c = canvas.getContext('2d')
canvas.width = canvas.clientWidth // * devicePixelRatio
canvas.height = canvas.clientHeight // * devicePixelRatio

let response = await fetch('data.txt.gz')
let gunzip = new DecompressionStream('gzip')
let stream = response.body.pipeThrough(gunzip)
let reader = stream.getReader()
let reader_count = 0

let FRAME_PIXELS = canvas.width * canvas.height
let FRAME_ITEMS = FRAME_PIXELS * 4
let frame_buffer = new Uint8ClampedArray(FRAME_ITEMS)
let frame_buffer_index = 0

let frames = []
let frames_count = 0

while (true) {
    let {value, done} = await reader.read()
    if (done) break

    let rgba = [0, 0, 0, 255]
    for (let item of value) {
        reader_count++
        switch (item) {
            case 61: // =
                rgba = [255, 255, 255, 255]
                break
            case 43: // +
                rgba = [0, 255, 0, 255]
                break
            case 45: // -
                rgba = [255, 0, 0, 255]
                break
            default: // eof
        }
        pixel_save(rgba)
    }
}

function pixel_save(rgba) {
    if (frame_buffer_index >= FRAME_ITEMS) {
        let frame = new ImageData(frame_buffer, canvas.width, canvas.height)

        if (frames_count < 4) {
            console.log('frame_buffer', frame_buffer)
            console.log('ImageData', frame)
        }

        frames.push(frame)
        frames_count++
        frame_buffer_index = 0
    }

    frame_buffer[frame_buffer_index] = rgba[0]
    frame_buffer_index++
    frame_buffer[frame_buffer_index] = rgba[1]
    frame_buffer_index++
    frame_buffer[frame_buffer_index] = rgba[2]
    frame_buffer_index++
    frame_buffer[frame_buffer_index] = rgba[3]
    frame_buffer_index++
}

console.info('reader count', reader_count)
console.info(`frame pixels (${canvas.width}x${canvas.height})`, FRAME_PIXELS)
console.info('frame buffer length', frame_buffer.length)
console.info('frames (theoretical)', reader_count / FRAME_PIXELS)
console.info('frames (actual)', frames.length)

let i = 0
setInterval(async function () {
    if (i >= frames.length) i = 0

    console.info(`painting ${i} / ${frames.length}`)
    c.putImageData(frames[i], 0, 0)

    i++
}, 1000)

</script>
